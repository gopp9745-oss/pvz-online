<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ - PvZ Online</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .mod-wrapper { max-width: 900px; margin: 0 auto; padding: 20px; }
    .mod-header { display: flex; align-items: center; gap: 15px; margin-bottom: 24px; background: rgba(0,0,0,0.5); border-radius: 16px; padding: 16px 20px; border: 1px solid #FFD700; }
    .mod-badge { background: linear-gradient(135deg, #FF8C00, #FFD700); color: #000; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 13px; }
    .mod-title { font-size: 22px; font-weight: 700; color: #FFD700; }
    .mod-expires { font-size: 12px; color: #aaa; margin-top: 4px; }
    .mod-section { background: rgba(0,0,0,0.4); border-radius: 14px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    .mod-section h3 { color: #FFD700; margin: 0 0 16px; font-size: 16px; }
    .perm-badge { display: inline-block; background: rgba(76,175,80,0.2); border: 1px solid #4CAF50; color: #4CAF50; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin: 2px; }
    .perm-badge.locked { background: rgba(244,67,54,0.2); border-color: #f44336; color: #f44336; }
    .users-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
    .user-row { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 14px; }
    .user-row .uname { flex: 1; font-weight: 600; color: #fff; }
    .user-row .ustats { font-size: 12px; color: #aaa; }
    .user-row .ucoins { color: #FFD700; font-size: 13px; }
    .give-coins-form { display: flex; gap: 8px; align-items: center; }
    .give-coins-form input { width: 80px; }
    .mod-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mod-form .full { grid-column: 1/-1; }
    .mod-notice { background: rgba(255,152,0,0.15); border: 1px solid #FF9800; border-radius: 10px; padding: 12px 16px; color: #FF9800; font-size: 13px; margin-bottom: 16px; }
    .locked-section { opacity: 0.5; pointer-events: none; position: relative; }
    .locked-section::after { content: 'üîí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 8px; color: #f44336; font-weight: 700; }
    .timer-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 8px; overflow: hidden; }
    .timer-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #FFD700); border-radius: 3px; transition: width 1s linear; }
  </style>
</head>
<body class="admin-bg">
  <div class="mod-wrapper">

    <div class="mod-header">
      <div>
        <div class="mod-title">üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
        <div class="mod-expires" id="mod-expires">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="timer-bar"><div class="timer-fill" id="timer-fill" style="width:100%"></div></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center;">
        <div id="mod-badge" class="mod-badge">–ú–û–î–ï–†–ê–¢–û–†</div>
        <button class="btn btn-secondary btn-sm" onclick="window.location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <div id="mod-notice" class="mod-notice hidden">
      ‚ö†Ô∏è –í–∞—à–∏ –ø—Ä–∞–≤–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
    </div>

    <!-- –ú–æ–∏ –ø—Ä–∞–≤–∞ -->
    <div class="mod-section">
      <h3>üîë –ú–æ–∏ –ø—Ä–∞–≤–∞</h3>
      <div id="perms-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="mod-section" id="section-users">
      <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <input type="text" id="mod-search" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." oninput="filterModUsers()" style="margin-bottom:12px;width:100%">
      <div class="users-list" id="mod-users-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –í—ã–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã -->
    <div class="mod-section" id="section-coins">
      <h3>ü™ô –í—ã–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã –∏–≥—Ä–æ–∫—É</h3>
      <div class="mod-notice">‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 500 –º–æ–Ω–µ—Ç –∑–∞ —Ä–∞–∑</div>
      <div class="mod-form">
        <div>
          <label class="input-label">–ò–≥—Ä–æ–∫</label>
          <select id="mod-coin-target" class="input-field">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>
          </select>
        </div>
        <div>
          <label class="input-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (–º–∞–∫—Å. 500)</label>
          <input type="number" id="mod-coin-amount" class="input-field" placeholder="100" min="1" max="500">
        </div>
        <div class="full">
          <button class="btn btn-success" onclick="modGiveCoins()">ü™ô –í—ã–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã</button>
        </div>
      </div>
    </div>

    <!-- –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ -->
    <div class="mod-section" id="section-promo">
      <h3>üéüÔ∏è –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
      <div class="mod-notice">‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞: 200 –º–æ–Ω–µ—Ç</div>
      <div class="mod-form">
        <div>
          <label class="input-label">–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞</label>
          <input type="text" id="mod-promo-code" class="input-field" placeholder="PROMO2024">
        </div>
        <div>
          <label class="input-label">–ù–∞–≥—Ä–∞–¥–∞ (–º–∞–∫—Å. 200)</label>
          <input type="number" id="mod-promo-reward" class="input-field" placeholder="100" min="1" max="200">
        </div>
        <div>
          <label class="input-label">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (0 = ‚àû)</label>
          <input type="number" id="mod-promo-uses" class="input-field" placeholder="0" min="0">
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="btn btn-primary" onclick="modCreatePromo()">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="mod-result" class="hidden" style="margin-top:16px;"></div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();
    var myUserId = null;
    var modData = null;
    var modExpires = null;
    var timerInterval = null;

    function showToast(msg, type) {
      var t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.className = 'toast ' + (type || 'success');
      t.classList.remove('hidden');
      setTimeout(function() { t.classList.add('hidden'); }, 3000);
    }

    window.addEventListener('DOMContentLoaded', function() {
      var saved = localStorage.getItem('pvz_user');
      if (!saved) { window.location.href = '/'; return; }
      try { var u = JSON.parse(saved); myUserId = u.id; } catch(e) { window.location.href = '/'; return; }
      socket.emit('mod_get_data', { userId: myUserId });
    });

    socket.on('mod_data', function(data) {
      if (!data.success) {
        document.body.innerHTML = '<div style="text-align:center;padding:60px;color:#f44336;font-size:20px;">‚ùå ' + data.message + '<br><br><a href="/" style="color:#4CAF50">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></div>';
        return;
      }
      modData = data;
      modExpires = data.expiresAt;
      renderModPanel(data);
    });

    function renderModPanel(data) {
      var perms = data.perms || [];
      var isAll = perms.includes('all');

      // –ü—Ä–∞–≤–∞
      var permNames = {
        'all': 'üëë –í—Å–µ –ø—Ä–∞–≤–∞ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)',
        'view_users': 'üë• –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        'give_coins': 'ü™ô –í—ã–¥–∞—á–∞ –º–æ–Ω–µ—Ç (–º–∞–∫—Å. 500)',
        'create_promo': 'üéüÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–º–∞–∫—Å. 200 –º–æ–Ω–µ—Ç)',
        'view_promos': 'üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤'
      };
      var allPerms = ['view_users', 'give_coins', 'create_promo', 'view_promos'];
      var permsList = document.getElementById('perms-list');
      permsList.innerHTML = '';
      if (isAll) {
        permsList.innerHTML = '<span class="perm-badge">üëë –í—Å–µ –ø—Ä–∞–≤–∞ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</span>';
      } else {
        allPerms.forEach(function(p) {
          var has = perms.includes(p);
          var span = document.createElement('span');
          span.className = 'perm-badge' + (has ? '' : ' locked');
          span.textContent = (has ? '‚úÖ ' : 'üîí ') + (permNames[p] || p);
          permsList.appendChild(span);
        });
      }

      // –¢–∞–π–º–µ—Ä
      if (modExpires) {
        document.getElementById('mod-notice').classList.remove('hidden');
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        document.getElementById('mod-expires').textContent = '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞';
      }

      // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–∫—Ü–∏–∏ –±–µ–∑ –ø—Ä–∞–≤
      if (!isAll && !perms.includes('give_coins')) {
        document.getElementById('section-coins').classList.add('locked-section');
      }
      if (!isAll && !perms.includes('create_promo')) {
        document.getElementById('section-promo').classList.add('locked-section');
      }

      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      renderUsers(data.users || []);
    }

    function updateTimer() {
      if (!modExpires) return;
      var left = Math.max(0, modExpires - Date.now());
      var h = Math.floor(left / 3600000);
      var m = Math.floor((left % 3600000) / 60000);
      var s = Math.floor((left % 60000) / 1000);
      document.getElementById('mod-expires').textContent = 
        '–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑: ' + h + '—á ' + m + '–º ' + s + '—Å';
      
      // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –º–∞–∫—Å 24—á)
      var maxDur = 24 * 3600000;
      var pct = Math.min(100, (left / maxDur) * 100);
      var fill = document.getElementById('timer-fill');
      if (fill) fill.style.width = pct + '%';
      
      if (left <= 0) {
        clearInterval(timerInterval);
        document.getElementById('mod-expires').textContent = '‚õî –°—Ä–æ–∫ –∏—Å—Ç—ë–∫!';
        showToast('–°—Ä–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ –∏—Å—Ç—ë–∫!', 'error');
        setTimeout(function() { window.location.href = '/'; }, 3000);
      }
    }

    var allUsers = [];
    function renderUsers(users) {
      allUsers = users;
      var select = document.getElementById('mod-coin-target');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>';
      users.forEach(function(u) {
        var opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.username + ' (' + u.coins + ' ü™ô)';
        select.appendChild(opt);
      });
      filterModUsers();
    }

    function filterModUsers() {
      var q = (document.getElementById('mod-search').value || '').toLowerCase();
      var list = document.getElementById('mod-users-list');
      list.innerHTML = '';
      var filtered = allUsers.filter(function(u) { return u.username.toLowerCase().includes(q); });
      if (!filtered.length) { list.innerHTML = '<div style="color:#aaa;text-align:center;padding:20px;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
      filtered.forEach(function(u) {
        var row = document.createElement('div');
        row.className = 'user-row';
        var badge = u.isAdmin ? 'üëë' : u.isModerator ? 'üõ°Ô∏è' : 'üë§';
        var expStr = '';
        if (u.isModerator && u.moderatorExpires) {
          var left = Math.max(0, u.moderatorExpires - Date.now());
          var h = Math.floor(left / 3600000);
          expStr = ' <span style="color:#FF9800;font-size:11px;">(–º–æ–¥. ' + h + '—á)</span>';
        }
        row.innerHTML = 
          '<span style="font-size:18px;">' + badge + '</span>' +
          '<span class="uname">' + u.username + expStr + '</span>' +
          '<span class="ustats">üèÜ ' + u.wins + ' | üíÄ ' + u.losses + '</span>' +
          '<span class="ucoins">ü™ô ' + u.coins + '</span>';
        list.appendChild(row);
      });
    }

    function modGiveCoins() {
      var targetId = document.getElementById('mod-coin-target').value;
      var amount = parseInt(document.getElementById('mod-coin-amount').value) || 0;
      if (!targetId) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞!', 'error'); return; }
      if (amount <= 0 || amount > 500) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 1 –¥–æ 500!', 'error'); return; }
      socket.emit('mod_give_coins', { userId: myUserId, targetId: targetId, amount: amount });
    }

    function modCreatePromo() {
      var code = document.getElementById('mod-promo-code').value.trim();
      var reward = parseInt(document.getElementById('mod-promo-reward').value) || 0;
      var maxUses = parseInt(document.getElementById('mod-promo-uses').value) || 0;
      if (!code) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥!', 'error'); return; }
      if (reward <= 0 || reward > 200) { showToast('–ù–∞–≥—Ä–∞–¥–∞ –æ—Ç 1 –¥–æ 200!', 'error'); return; }
      socket.emit('mod_create_promo', { userId: myUserId, code: code, reward: reward, maxUses: maxUses || null });
    }

    socket.on('mod_action_result', function(data) {
      showToast(data.message, data.success ? 'success' : 'error');
      if (data.success) {
        socket.emit('mod_get_data', { userId: myUserId });
      }
    });
  </script>
</body>
</html>
